<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--病程记录
住院病历

检验结果-->
<mapper namespace="His">
    <cache eviction="LRU" readOnly="false" flushInterval="600000" size="10000"/>
    <resultMap id="CourseResult" type="com.zcreate.review.his.Course">
        <result column="title" jdbcType="VARCHAR" property="title"/>
        <result column="content" jdbcType="VARCHAR" property="content"/>
        <result column="doctorName" jdbcType="VARCHAR" property="doctorName"/>
        <result column="writeTime" jdbcType="TIMESTAMP" property="writeTime"/>
        <result column="confirmTime" jdbcType="TIMESTAMP" property="confirmTime"/>
    </resultMap>
    <resultMap id="HistoryResult" type="com.zcreate.review.his.History">
        <result column="content" jdbcType="VARCHAR" property="content"/>
        <result column="writeTime" jdbcType="TIMESTAMP" property="writeTime"/>
        <result column="doctorName1" jdbcType="VARCHAR" property="doctorName1"/>
        <result column="doctorName2" jdbcType="VARCHAR" property="doctorName2"/>
    </resultMap>
    <resultMap id="ExamDirResult" type="com.zcreate.review.his.ExamDir">
        <result column="examName" jdbcType="VARCHAR" property="examName"/>
        <result column="examItem" jdbcType="VARCHAR" property="examItem"/>
        <result column="serialNo" jdbcType="VARCHAR" property="serialNo"/>
    </resultMap>
    <resultMap id="ExamResult" type="com.zcreate.review.his.ExamResult">
        <result column="examTime" jdbcType="TIMESTAMP" property="examTime"/>
        <result column="examiner" jdbcType="VARCHAR" property="examiner"/>
        <result column="purpose" jdbcType="VARCHAR" property="purpose"/>
        <result column="substance" jdbcType="VARCHAR" property="substance"/>
        <result column="content" jdbcType="VARCHAR" property="content"/>
        <result column="contentType" jdbcType="VARCHAR" property="contentType"/>
    </resultMap>
    <!--   etonehis.${departCode}.william.    -->
    <!--   etonehis.${departCode}.william.    -->
    <select id="selectCourse" parameterType="java.util.Map" resultMap="CourseResult">
        SELECT p0252_002 writeTime, p0252_003 content, p0252_005 title, p0252_008 doctorName, p0252_009 confirmTime
        FROM ${prefix}.P0252
        WHERE zyh = #{serialNo:VARCHAR}
        ORDER BY p0252_002
    </select>
    <!--   etonehis.${departCode}.william.    -->
    <!--   etonehis.${departCode}.william.    -->
    <select id="selectHistory" parameterType="java.util.Map" resultMap="HistoryResult">
        SELECT TOP 1 A.p0253_002 content, A.p0253_007 writeTime, D1.name doctorName1, D2.name doctorName2
        FROM ${prefix}.P0253 A
                 LEFT JOIN Doctor D1
                           ON RIGHT(rtrim(A.p0253_005), 3) = D1.doctorNo
                 LEFT JOIN Doctor D2
                           ON RIGHT(rtrim(A.p0253_006), 3) = D2.doctorNo
        WHERE zyh = #{serialNo:VARCHAR}
        ORDER BY p0253_007 DESC
    </select>

    <!-- etonehis.hospital.william. -->
    <!-- etonehis.hospital.william. -->
    <select id="selectExamResult" parameterType="java.util.Map" resultMap="ExamResult">
        SELECT TOP 1 rtrim(P901_003) substance, rtrim(P901_004) purpose, P901_008 content, rtrim(P901_009) examiner, repo_type contentType, P901_007 examTime, rtrim(P901_013) memo
        FROM ${prefix}.P901
        WHERE P901_002 = #{serialNo:VARCHAR}
    </select>

    <!--PACS-->
    <select id="selectPACS" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT top 1 P1010_004 substance, p1010_003 purpose, p1010_009 content, P1010_006 examiner, 3 contentType, P1010_007 examTime
        FROM ${prefix}.P1010
        WHERE P1010_002 = #{serialNo:VARCHAR}
    </select>
    <!--功能检查报告-->
    <select id="selectFuncCheck" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT top 1 P831_004 substance, P831_003 purpose, P831_011 content, P831_008 examiner, 3 contentType, P831_009 examTime
        FROM ${prefix}.P831
        WHERE P831_002 = #{serialNo:VARCHAR}
    </select>
    <!--病理报告-->
    <select id="selectPathology" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT top 1 P1101_003 substance, p1101_006 purpose, p1101_010 content, P1101_007 examiner, 3 contentType, P1101_008 examTime
        FROM ${prefix}.P1101
        WHERE P1101_002 = #{serialNo:VARCHAR}
    </select>
    <!--会诊单-->
    <select id="selectConsultation" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT top 1 P1001_5 doctor, p1001_7 content, P1001_8 examTime
        FROM ${prefix}.P1001
        WHERE P1001_6 = 2 and P1001_3 = #{serialNo:VARCHAR}
    </select>
    <!--医技目录-->
    <!-- etonehis.${departCode}.william.  -->
    <select id="selectTechnologyDir" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT P1902_002 techName, count(P1902_002) techCount
        FROM ${prefix}.P1902
        where zyh = #{serialNo:VARCHAR}
        group by P1902_002
    </select>
    <!-- etonehis.${departCode}.william.  -->
    <select id="selectTechnology" parameterType="java.util.Map" resultType="java.util.HashMap">
        select rtrim(P1902_002) itemName, rtrim(P1902_003) reportName, P1902_008 reportID
        from ${prefix}.P1902
        where zyh = #{serialNo:VARCHAR}
    </select>
    <!-- etonehis.${departCode}.william.  -->
    <select id="selectTechnologyCount" parameterType="java.util.Map" resultType="int">
        select count(*)
        FROM ${prefix}.P1902
        WHERE zyh = #{serialNo:VARCHAR}
    </select>

    <!--护理记录-->
    <select id="selectNurseWatch" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT zyh, T001, T002, T003, T004, T005, T006, T007, T008
        FROM ${prefix}.hlbl_sgnx_hljl
        WHERE zyh = #{serialNo:VARCHAR}
    </select>
    <select id="selectNurse" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT zyh, XH, USERNO, T001, T002, T003, T004, T005, T006, T007, T008, T009, T010, T011, T012, T013, T014, T015, T016, T017, T018, T019
        FROM ${prefix}.hlbl_sgnx_hljl_list
        WHERE zyh = #{serialNo:VARCHAR}
        order by XH
    </select>
    <select id="selectNurseWatch_YBER" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT zyh, T001, T002, T003, T004, T005, T006
        FROM ${prefix}.eyhljldty
        WHERE zyh = #{serialNo:VARCHAR}
    </select>
    <select id="selectNurse_YBER" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT zyh, XH, USERNO, T001, T002, T003, T004, T005, T006, T007, T008, T009, T010, T011, T012, T013, T014, T015, T016, T017, T018, T019, T019
        FROM ${prefix}.eyhljldty_list
        WHERE zyh = #{serialNo:VARCHAR}
        order by XH
    </select>
    <select id="selectNurseWatch_WY" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT zyh, T001, T002, T003, T004, T005, T006, T007, T008
        FROM ${prefix}.WYHLJLDTY
        WHERE zyh = #{serialNo:VARCHAR}
    </select>
    <select id="selectNurse_WY" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT zyh, XH, USERNO, T001, T002, T003, T004, T005, T006, T007, T008, T009, T010, T011, T012, T013, T014, T015
        FROM ${prefix}.WYHLJLDTY_LIST
        WHERE zyh = #{serialNo:VARCHAR}
        order by XH
    </select>
    <select id="selectNurseCount" parameterType="java.util.Map" resultType="int">
        select count(*)
        FROM ${prefix}.hlbl_sgnx_hljl_list
        WHERE zyh = #{serialNo:VARCHAR}
    </select>
    <select id="selectNurseCount_WY" parameterType="java.util.Map" resultType="int">
        select count(*)
        FROM ${prefix}.WYHLJLDTY_LIST
        WHERE zyh = #{serialNo:VARCHAR}
    </select>
    <select id="selectNurseCount_YBER" parameterType="java.util.Map" resultType="int">
        select count(*)
        FROM ${prefix}.eyhljldty
        WHERE zyh = #{serialNo:VARCHAR}
    </select>
    <select id="selectIcuNurse" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT ZYH, USERNO, XH, H004_001, H004_002, H004_003, H004_004, H004_005, H004_006, H004_007, H004_008, H004_009, H004_010, H004_011,
               H004_012, H004_013, H004_014, H004_015, H004_016, H004_017, H004_018
        FROM ${prefix}.HLBL_SGNX_004
        WHERE zyh = #{serialNo:VARCHAR}
        order by XH
    </select>
    <select id="selectIcuNurseCount" parameterType="java.util.Map" resultType="int">
        select count(*)
        FROM ${prefix}.HLBL_SGNX_004
        WHERE zyh = #{serialNo:VARCHAR}
    </select>
    <select id="selectCriticalNurse" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT ZYH, USERNO, XH, H002_001, H002_002, H002_003, H002_004, H002_005, H002_006, H002_007, H002_008, H002_009, H002_010, H002_011, H002_012
        FROM ${prefix}.HLBL_SGNX_002
        WHERE zyh = #{serialNo:VARCHAR}
        order by XH
    </select>
    <select id="selectCriticalNurseCount" parameterType="java.util.Map" resultType="int">
        select count(*)
        FROM ${prefix}.HLBL_SGNX_002
        WHERE zyh = #{serialNo:VARCHAR}
    </select>
    <!--通过亿通HIS发通知给医生-->
    <parameterMap id="sendMsgParam" type="java.util.Map">
        <parameter property="doctorNo" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
        <parameter property="phmstNo" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
        <parameter property="pharmacists" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
        <parameter property="sendDept" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
        <parameter property="title" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
        <parameter property="content" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
        <parameter property="mail_id" jdbcType="INTEGER" javaType="java.lang.Integer" mode="OUT"/>
    </parameterMap>
    <update id="sendMsgToDoctor" parameterMap="sendMsgParam" statementType="CALLABLE">
        {call sendMsgToDoctor(?, ?, ?, ?, ?, ?, ?)}
    </update>

    <!--诊断-->
    <select id="selectDiagnosis" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT case A.LsInOut when 1 then '门诊诊断' when 2 then '住院诊断' else '' end type, A.IllDesc disease, /*B.Code icd,*/A.ID diagnosisNo
        FROM YBHis.LjHis.dbo.InHosMzIll A
             -- left join YBHis.LJHis.dbo.BsIllness B on A.icdid = B.ID
        where A.hospid = #{hospID:INTEGER}
        order by A.LsInOut, A.ListNum;
    </select>
</mapper>