<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="RxDetail">
    <cache eviction="LRU" readOnly="false" flushInterval="600000" size="1000"/>
    <resultMap id="RxDetailResult" type="com.zcreate.review.model.RxDetail">
        <result column="rxDetailID" jdbcType="INTEGER" property="rxDetailID"/>
        <result column="hospID" jdbcType="INTEGER" property="hospID"/>
        <result column="prescribeDate" jdbcType="TIMESTAMP" property="prescribeDate"/>
        <result column="goodsID" jdbcType="INTEGER" property="goodsID"/>
        <result column="medicineName" jdbcType="VARCHAR" property="medicineName"/>
        <result column="quantity" jdbcType="INTEGER" property="quantity"/>
        <result column="money" jdbcType="DOUBLE" property="money"/>
        <result column="frequency" jdbcType="VARCHAR" property="frequency"/>
        <result column="freqNum" jdbcType="INTEGER" property="freqNum"/>
        <result column="unit" jdbcType="VARCHAR" property="unit"/>
        <result column="dosage" jdbcType="VARCHAR" property="dosage"/>
        <result column="eachQuantity" jdbcType="DOUBLE" property="eachQuantity"/>
        <result column="eachUnit" jdbcType="VARCHAR" property="eachUnit"/>
        <result column="dayNum" jdbcType="INTEGER" property="dayNum"/>
        <result column="usage" jdbcType="VARCHAR" property="usage"/>
        <result column="minOfpack" jdbcType="INTEGER" property="minOfpack"/>
        <result column="price" jdbcType="DOUBLE" property="price"/>
        <result column="spec" jdbcType="VARCHAR" property="spec"/>
        <result column="orderID" jdbcType="INTEGER" property="orderID"/>
        <result column="groupID" jdbcType="INTEGER" property="groupID"/>
        <result column="instructionID" jdbcType="INTEGER" property="instructionID"/>
        <result column="audit" jdbcType="VARCHAR" property="audit"/>
        <result column="antiClass" jdbcType="INTEGER" property="antiClass"/>
        <result column="producer" jdbcType="VARCHAR" property="producer"/>
        <result column="generalName" jdbcType="VARCHAR" property="generalName"/>
        <result column="dose" jdbcType="VARCHAR" property="dose"/>
        <result column="medicineID" jdbcType="INTEGER" property="medicineID"/>
    </resultMap>
    <sql id="queryWhere">
        <where>
            <if test="rxDetailID > 0">AND rxDetailID=#{rxDetailID}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(hospID)">AND hospID=#{hospID}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(prescribeDate)">AND prescribeDate=#{prescribeDate}</if>
        </where>
    </sql>
    <select id="selectRxDetail2Review" parameterType="java.util.Map" resultMap="RxDetailResult">
        SELECT R.rxDetailID,M.chnName medicineName,R.goodsID, R.eachQuantity,R.eachUnit,R.dayNum,R.usage, R.quantity,R.frequency,R.freqNum,
               R.unit, M.matchInstrID instructionID, R.dosage,R.spec,R.groupID,R.orderID ,R.audit,M.antiClass,M.producer,D.chnName generalName,M.dose,M.medicineID
        FROM ${RxDetailTable} R
        LEFT JOIN Medicine M ON R.goodsID=M.goodsID
        LEFT JOIN Drug D ON D.drugID=M.matchDrugID
        WHERE R.clinicID=#{clinicID:INTEGER}
        ORDER BY R.rxNo,R.groupID,R.orderID
    </select>

    <select id="selectVDPatient" parameterType="java.util.Map" resultType="java.util.HashMap">
        select count(distinct A.hospID) vdPatient,count(distinct case when B.hospID IS not null then B.hospID else null end) antiVdPatient,
         count(distinct case when B.hospID IS not null and C.hospID IS not null then B.hospID else null  end) antiVdEmerPatient
        from
        (select  hospID,convert(varchar(10) ,prescribeDate,120)pDate from ${RxDetailTable} where  dosage like '%vd%'  and prescribeDate>#{fromDate:TIMESTAMP} and prescribeDate &lt; #{toDate:TIMESTAMP}) A
        left join
        (select hospID,convert(varchar(10) ,prescribeDate,120)pDate from ${RxDetailTable} where goodsID in(select goodsID from Medicine where antiClass>1)
         and prescribeDate>#{fromDate:TIMESTAMP} and prescribeDate &lt; #{toDate:TIMESTAMP}) B on A.hospID=B.hospID and A.pDate=B.pDate
        left join
        (select hospID,convert(varchar(10) ,prescribeDate,120)pDate from Rx where  clinicType = '急诊方'
        and prescribeDate>#{fromDate:TIMESTAMP} and prescribeDate &lt; #{toDate:TIMESTAMP}) C on A.hospID=C.hospID and A.pDate=C.pDate
    </select>
    <select id="selectEmergencyPatient" parameterType="java.util.Map" resultType="java.util.HashMap">
        select COUNT(distinct rx.hospID) emergPatient,  sum(rd.money) emergDrugMoney,
        count(distinct case when M.antiClass>1 then M.goodsID else null end) emergAntiDrugNum ,
        sum( case when M.antiClass>1 then rd.money else null end) emergAntiDrugMoney
        from Rx
        left join ${RxDetailTable} Rd on rx.hospID=rd.hospID
        left join Medicine M on M.goodsID=Rd.goodsID
        where rx.prescribeDate>#{fromDate:TIMESTAMP} and rx.prescribeDate &lt; #{toDate:TIMESTAMP} and rx.clinicType='急诊方'
    </select>
    <select id="selectRxDetailCount" parameterType="java.util.Map" resultType="int">
        SELECT count(*) FROM ${RxDetailTable}
        <include refid="queryWhere"/>
    </select>

    <sql id="queryWhere2">
        <where>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(hospID)">AND R.hospID=#{hospID:INTEGER}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(fromDate)">AND R.prescribeDate >= #{fromDate:TIMESTAMP}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(toDate)">AND R.prescribeDate &lt; #{toDate:TIMESTAMP}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(goodsID)">AND R.goodsID = #{goodsID:INTEGER}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(medicineName)">AND M.chnName LIKE '%${medicineName}%'</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(healthNo)">AND M.healthNo LIKE '${healthNo}%'</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(patient)">AND ( Rx.patientName=#{patient:VARCHAR} OR R.hospID=#{patient:VARCHAR})</if>
            <if test="type>0">AND Rx.type = #{type:INTEGER}</if>
        </where>
    </sql>
    <select id="queryPatientDrug" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT TOP ${limit}
        a.hospID,A.patientName,A.prescribeDate,a.chnName drugName,a.spec,A.quantity,A.minUnit,A.dosage,A.eachQuantity,A.eachUnit,A.dayNum,A.usage FROM
        (SELECT R.rxDetailID, R.hospID,Rx.patientName,R.prescribeDate,M.chnName,M.spec,R.quantity,M.minUnit,R.dosage,R.eachQuantity,R.eachUnit,R.dayNum,R.usage
        FROM ${RxDetailTable} R
        LEFT JOIN Rx ON R.rxID=Rx.rxID
        LEFT JOIN Medicine M ON R.goodsID=M.goodsID
        <include refid="queryWhere2"/>)A
        <if test="start!=null and start > 0">
            WHERE rxDetailID &lt; (
            SELECT min(rxDetailID) FROM (SELECT TOP ${start} rxDetailID FROM ${RxDetailTable} R LEFT JOIN Rx ON R.rxID=Rx.rxID LEFT JOIN Medicine M ON R.goodsID=M.goodsID
            <include refid="queryWhere2"/>
            ORDER BY rxDetailID DESC ) A )
        </if>
        ORDER BY rxDetailID DESC
    </select>
    <select id="queryPatientDrugCount" parameterType="java.util.Map" resultType="int">
        SELECT count(R.rxDetailID) FROM ${RxDetailTable} R LEFT JOIN Rx ON R.rxID=Rx.rxID
        <if test="@com.zcreate.util.Ognl@isNotEmpty(healthNo) or @com.zcreate.util.Ognl@isNotEmpty(medicineName) ">LEFT JOIN Medicine M ON R.goodsID=M.goodsID</if>
        <include refid="queryWhere2"/>
    </select>

    <select id="medicineTrend" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT cast(d1 AS DATETIME) AS 'date',number,quantity,amount FROM (
        SELECT convert(VARCHAR(10),rx.prescribeDate,120) 'd1' ,count(DISTINCT(R.goodsID)) 'number', sum(R.quantity) 'quantity',sum(R.money) 'amount'
        FROM ${RxDetailTable} R LEFT JOIN rx ON R.rxID=Rx.rxID
        <where>
            <if test="type>0">AND Rx.type = #{type:INTEGER}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(department)">AND Rx.department = #{department:VARCHAR}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(fromDate)">AND Rx.prescribeDate >= #{fromDate:TIMESTAMP}</if>
            <if test="@com.zcreate.util.Ognl@isNotEmpty(toDate)">AND Rx.prescribeDate &lt; #{toDate:TIMESTAMP}</if>
        </where>
        GROUP BY convert(VARCHAR(10),rx.prescribeDate,120))A
        ORDER BY d1
    </select>

</mapper>